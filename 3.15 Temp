from machine import UART
import time

# UART haute performance
uart = UART(1, baudrate=115200, rx=22, tx=23, timeout=5)

# --- CONFIGURATION ---
OFFSET = 8  # On retire les 8cm de décalage que tu observes
MIN_STRENGTH = 100 # On ignore si le signal est trop faible

def read_fast():
    print("FLUX MAXIMUM ACTIVÉ...")
    while True:
        # On ne traite que si on a au moins une trame
        if uart.any() >= 9:
            # On lit tout le buffer pour ne pas accumuler de retard
            data = uart.read()
            
            # On cherche TOUTES les trames dans le paquet lu
            idx = 0
            while True:
                idx = data.find(b'\x59\x59', idx)
                if idx == -1 or (idx + 8) >= len(data):
                    break
                
                # Extraction
                d_raw = data[idx+2] + (data[idx+3] << 8)
                strength = data[idx+4] + (data[idx+5] << 8)
                checksum = data[idx+8]
                
                # Validation ultra-rapide
                if (sum(data[idx:idx+8]) & 0xFF) == checksum:
                    if strength >= MIN_STRENGTH:
                        # APPLICATION DE LA CORRECTION
                        d_correct = d_raw - OFFSET
                        print(f"Dist: {d_correct}cm (Brut: {d_raw} | Sig: {strength})")
                
                idx += 9 # On passe à la trame suivante dans le buffer

# Nettoyage et lancement
if uart.any():
    uart.read()
read_fast()
