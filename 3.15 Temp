from machine import UART
import time

# Configuration UART
uart = UART(1, baudrate=115200, rx=22, tx=23, timeout=10)

# --- CONFIGURATION ---
OFFSET = 8         # Correction de ton décalage de 8cm
MIN_STRENGTH = 100  # Seuil de fiabilité du signal

def read_once_per_second():
    print("LECTURE : 1 MESURE PAR SECONDE...")
    
    while True:
        time.sleep(1)
        
        if uart.any() >= 9:
            data = uart.read()
            
            idx = data.rfind(b'\x59\x59')
            
            if idx != -1 and (idx + 8) < len(data):
                d_raw = data[idx+2] + (data[idx+3] << 8)
                strength = data[idx+4] + (data[idx+5] << 8)
                checksum = data[idx+8]
                
                if (sum(data[idx:idx+8]) & 0xFF) == checksum:
                    if strength >= MIN_STRENGTH:
                        d_correct = d_raw - OFFSET
                        print(f"Dist: {d_correct}cm (Brut: {d_raw} | Sig: {strength})")
                    else:
                        print("Signal trop faible")
                else:
                    print("Erreur Checksum")

# Nettoyage initial du tampon
if uart.any():
    uart.read()

# Lancement
read_once_per_second()
